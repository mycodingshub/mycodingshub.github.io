<!doctype html>
<html lang="ko" data-bs-theme="auto">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="preload" href="https://mycodingshub.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://mycodingshub.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://mycodingshub.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2" as="font" type="font/woff2" crossorigin>
<script 
  src="/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js"
  integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg=">
</script>


<link rel="stylesheet" href="/main.86b7305f5a96b7dd3a46fa6277d87b125af3bf13f48c4cfcc269be84fa9e8fb75375d45a5fe9056ce9190644b7a6e5f13f917f12d853ed38bb76d8856898f755.css" integrity="sha512-hrcwX1qWt906Rvpid9h7ElrzvxP0jEz8wmm+hPqej7dTddRaX+kFbOkZBkS3puXxP5F/EthT7Ti7dtiFaJj3VQ==" crossorigin="anonymous">

<noscript><style>img.lazyload { display: none; }</style></noscript><title>astrojs 강좌 10편. astrojs에서 쿠키와 토큰을 이용해서 유저 로그인 구현</title>
<meta name="description" content="유저 정보를 jsonwebtoken으로 만들어서 쿠키에 저장해서 유저 로그인 구현" />
<link rel="canonical" href="https://mycodingshub.github.io/blog/2024-01-02-astrojs-auth-user-login-by-cookie-with-jwt-token/" />
<meta name="robots" content="index, follow" />

<meta property="og:type" content="article" />
<meta property="og:title" content="astrojs 강좌 10편. astrojs에서 쿠키와 토큰을 이용해서 유저 로그인 구현" />
<meta property="og:description" content="유저 정보를 jsonwebtoken으로 만들어서 쿠키에 저장해서 유저 로그인 구현" />
<meta property="og:url" content="https://mycodingshub.github.io/blog/2024-01-02-astrojs-auth-user-login-by-cookie-with-jwt-token/" />
<meta property="og:site_name" content="Home" />
<meta property="og:image" content="https://mycodingshub.github.io/cover.png" />
<meta property="og:locale" content="en" />
<meta property="article:published_time" content="2024-01-02T11:53:41Z" />
<meta property="article:modified_time" content="2024-01-02T11:53:41Z" />
<meta property="article:tag" content="astrojs" />
<meta property="article:tag" content="auth" />
<meta property="article:tag" content="cookie" />
<meta property="article:tag" content="jwt" />
<meta property="article:tag" content="token" />
<meta property="article:tag" content="jsonwebtoken" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="astrojs 강좌 10편. astrojs에서 쿠키와 토큰을 이용해서 유저 로그인 구현" />
<meta name="twitter:description" content="유저 정보를 jsonwebtoken으로 만들어서 쿠키에 저장해서 유저 로그인 구현" />
<meta name="twitter:image" content="https://mycodingshub.github.io/cover.png" />

<meta name="author" content="cpro95@gmail.com" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "\"astrojs 강좌 10편. astrojs에서 쿠키와 토큰을 이용해서 유저 로그인 구현\"",
  "description": "\"유저 정보를 jsonwebtoken으로 만들어서 쿠키에 저장해서 유저 로그인 구현\"",
  "datePublished": "\"2024-01-02T11:53:41Z\"",
  "dateModified": "\"2024-01-02T11:53:41Z\"",
  "author": {
    "@type": "Person",
    "name": "\"cpro95@gmail.com\""
  },
  "image": "\"https://mycodingshub.github.io/cover.png\"",
  "url": "\"https://mycodingshub.github.io/blog/2024-01-02-astrojs-auth-user-login-by-cookie-with-jwt-token/\"",
  "publisher": {
    "@type": "Organization",
    "name": "\"Home\""
  }
}
</script>




<script async src="https://www.googletagmanager.com/gtag/js?id=G-C7SBETWEJ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-C7SBETWEJ0');
</script>


<script
  async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7748316956330968"
  crossOrigin="anonymous"
></script>


</head>

  
  <body class="single section blog" data-bs-spy="scroll" data-bs-target="#toc" data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll="true" tabindex="0">
    <div class="sticky-top">
<header class="navbar navbar-expand-sm">
  <div class="container-lg">
  <div class="d-flex flex-grow-1 justify-content-between">
    <div class="d-flex flex-row navbar-nav justify-content-between align-items-start gap-2">
    
    <a class="nav-link fw-bold fs-4" href="/">Home</a>

    
    
            <a class="nav-link fs-4  active" href="https://mycodingshub.github.io/blog/" aria-current="true">Blog</a>
          
        
            <a class="nav-link fs-4 " href="https://mycodingshub.github.io/life/">Life</a>
          
        
    </div>
    <div class="d-flex flex-row justify-content-between align-items-center">
      
      
      <button type="button" id="searchToggleMobile" class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <circle cx="10" cy="10" r="7"></circle>
          <line x1="21" y1="21" x2="15" y2="15"></line>
        </svg>
      </button>
      
      
      <button type="button" id="searchToggleDesktop" class="btn btn-link nav-link p-2 d-none d-lg-block" aria-label="Search website">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <circle cx="10" cy="10" r="7"></circle>
          <line x1="21" y1="21" x2="15" y2="15"></line>
        </svg>
      </button>
      
      <button id="buttonColorMode" class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type="button" aria-label="Toggle theme">
        <svg data-bs-theme-value="dark" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
        </svg>
        <svg data-bs-theme-value="light" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0m-5 0h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7"></path>
        </svg>
      </button>
      </div>
        
        
        
        
        </div>
    </div>

    
    </div>
</header>
</div>

<div class="modal" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5 visually-hidden" id="searchModalLabel">Search</h1>
        <button type="button" class="btn-close visually-hidden" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="search-input flex-grow-1 d-none">
          <form id="search-form" class="search-form" action="#" method="post" accept-charset="UTF-8" role="search">
            <label for="query" class="visually-hidden">Search</label>
            <div class="d-flex">
              <input type="search" id="query" name="query" class="search-text form-control form-control-lg" placeholder="Search" aria-label="Search" maxlength="128" autocomplete="off">
              <button type="button" class="btn btn-link text-decoration-none px-0 ms-3 d-md-none" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-body">
        <p class="search-loading status message d-none mt-3 text-center">Loading search index…</p>
        <p class="search-no-recent message d-none mt-3 text-center">No recent searches</p>
        <p class="search-no-results message d-none mt-3 text-center">No results for "<strong><span class="query-no-results">Query here</span></strong>"</p>
        <div id="searchResults" class="search-results"></div>
        <template>
          <article class="search-result list-view">
            <div class="card my-3">
              <div class="card-body">
                <header>
                  <h2 class="h5 title title-submitted mb-0"><a class="stretched-link text-decoration-none text-reset" href="#">Title here</a></h2>
                  <div class="submitted d-none"><time class="created-date">Date here</time></div>
                </header>
                <div class="content">Summary here</div>
              </div>
            </div>
          </article>
        </template>
      </div>
      <div class="modal-footer">
        <ul class="list-inline me-auto d-none d-md-block">
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4M7 11.53088l-3-3 3-3"></path></g></svg></kbd><span class="DocSearch-Label">to select</span></li>
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8M10.5 8.5l-3 3-3-3"></path></g></svg></kbd><kbd class="me-2"><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8M10.5 6.5l-3-3-3 3"></path></g></svg></kbd><span class="DocSearch-Label">to navigate</span></li>
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993 0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016.8634 0 1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5c.032.5663-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864 0 1.6425 1.031 1.5443 2.2492h-2.956"></path></g></svg></kbd><span class="DocSearch-Label">to close</span></li>
        </ul>
        <p class="d-md-none">Search by <a class="text-decoration-none" href="https://github.com/nextapps-de/flexsearch">FlexSearch</a></p>
      </div>
    </div>
  </div>
</div>


    <div class="wrap container-lg" role="document">
      <div class="content">
      
        
<article>
  <div class="row justify-content-center">
    <div class="col-md-12 col-lg-12">
      
      <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-7748316956330968"
        data-ad-slot="2971373181"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      <div class="blog-header">
        <h1>astrojs 강좌 10편. astrojs에서 쿠키와 토큰을 이용해서 유저 로그인 구현</h1>
        <p>
  <small>January 2, 2024<span class="stretched-link position-relative reading-time text-nowrap" title="Estimated reading time"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
        <path d="M12 7v5l3 3"></path>
      </svg>26&nbsp;minutes</span></small>
</p>

      </div>
    </div>
      <div class="col-md-12 col-lg-12">
      
      <p>안녕하세요?</p>
<p>오랜만에 astrojs 강좌를 이어가네요.</p>
<p>오늘로 벌서 astrojs 강좌가 10번째네요.</p>
<p>전체 astrojs 강좌 목록입니다.</p>
<ol>
<li>
<p><a href="https://mycodingshub.github.io/blog/2023-10-07-astrojs-tutorial-how-to-handle-data-in-astrojs">astrojs 강좌 1편. astrojs에서 데이터 가져오기</a></p>
</li>
<li>
<p><a href="https://mycodingshub.github.io/blog/2023-10-14-astrojs-tutorial-clean-build-of-darkmode-theme">astrojs 강좌 2편. React 쓰지 않고 순수 자바스크립트로 Dark Mode 만드는 법</a></p>
</li>
<li>
<p><a href="https://mycodingshub.github.io/blog/2023-10-14-understanding-astosjs-island-architecture-from-making-my-own-island-web-component">astrojs 강좌 3편. 웹 컴포넌트로 직접 아일랜드 아키텍처 구현해 보기</a></p>
</li>
<li>
<p><a href="https://mycodingshub.github.io/blog/2023-10-21-astrojs-in-depth-review-component-island-architecture">astrojs 강좌 4편. astrojs 아일랜드 아키텍처 완벽 분석</a></p>
</li>
<li>
<p><a href="https://mycodingshub.github.io/blog/2023-10-29-astrojs-all-about-routing-and-dynamic-routing">astrojs 강좌 5편. astrojs 라우팅 완벽 분석(routing, dynamic routing)</a></p>
</li>
<li>
<p><a href="https://mycodingshub.github.io/blog/2023-10-29-astrojs-howto-use-content-collection-and-dynamic-routing">astrojs 강좌 6편. astrojs Content Collection과 다이내믹 라우팅 접목하기</a></p>
</li>
<li>
<p><a href="https://mycodingshub.github.io/blog/2023-10-30-astrojs-howto-use-ssr-in-astrojs-server-side-rendering">astrojs 강좌 7편. astrojs Server Side Rendering(SSR) 완벽 분석</a></p>
</li>
<li>
<p><a href="https://mycodingshub.github.io/blog/2023-11-08-astrojs-how-to-ssr-with-firebase-user-session">astrojs 강좌 8편. astrojs와 firebase로 유저 로그인 구현</a></p>
</li>
<li>
<p><a href="https://mycodingshub.github.io/blog/2023-11-09-astrojs-howto-supabase-authentication-with-ssr">astrojs 강좌 9편. astrojs와 supabase로 유저 로그인 구현</a></p>
</li>
<li>
<p><a href="https://mycodingshub.github.io/blog/2024-01-02-astrojs-auth-user-login-by-cookie-with-jwt-token">astrojs 강좌 10편. astrojs에서 쿠키와 토큰을 이용해서 유저 로그인 구현</a></p>
</li>
<li>
<p><a href="https://mycodingshub.github.io/blog/2024-01-16-astrojs-tutorial-auth-with-lucia">astrojs 강좌 11편. astrojs와 lucia를 이용해서 유저 인증 구현</a></p>
</li>
</ol>
<hr>
<p>** 목 차 **</p>
<ul>
<li><a href="#1-astro-%ed%85%9c%ed%94%8c%eb%a6%bf-%ec%84%a4%ec%b9%98">1. Astro 템플릿 설치</a></li>
<li><a href="#2-%ec%bf%a0%ed%82%a4-%ec%84%a4%ec%a0%95">2. 쿠키 설정</a></li>
<li><a href="#3-middleware-%ec%84%a4%ec%a0%95">3. middleware 설정</a></li>
<li><a href="#4-prisma-%ec%84%a4%ec%a0%95">4. Prisma 설정</a>
<ul>
<li><a href="#4-1-prisma-%ec%84%a4%ec%b9%98">4-1. Prisma 설치</a></li>
</ul>
</li>
<li><a href="#4-2-model-%ec%84%a4%ec%a0%95">4-2. Model 설정</a>
<ul>
<li><a href="#4-3-%ed%85%8c%ec%9d%b4%eb%b8%94-%eb%a7%8c%eb%93%a4%ea%b8%b0">4-3. 테이블 만들기</a></li>
<li><a href="#4-4-prisma-studio%ec%97%90%ec%84%9c-%eb%b3%b4%ea%b8%b0">4-4. Prisma Studio에서 보기</a></li>
</ul>
</li>
<li><a href="#5-ui-%eb%a7%8c%eb%93%a4%ea%b8%b0">5. UI 만들기</a>
<ul>
<li><a href="#5-1-%eb%a0%88%ec%9d%b4%ec%95%84%ec%9b%83-%ed%8c%8c%ec%9d%bc-%eb%a7%8c%eb%93%a4%ea%b8%b0">5-1. 레이아웃 파일 만들기</a></li>
</ul>
</li>
<li><a href="#5-2-%eb%a3%a8%ed%8a%b8-%ed%8e%98%ec%9d%b4%ec%a7%80%ec%99%80-%eb%8c%80%ec%8b%9c%eb%b3%b4%eb%93%9c-%ed%8e%98%ec%9d%b4%ec%a7%80-%eb%a7%8c%eb%93%a4%ea%b8%b0">5-2. 루트 페이지와 대시보드 페이지 만들기</a></li>
<li><a href="#6-%ec%9d%b8%ec%a6%9d-%ea%b4%80%eb%a0%a8-%ec%bd%94%eb%93%9c-%ec%84%a4%ec%a0%95">6. 인증 관련 코드 설정</a>
<ul>
<li><a href="#6-1-prisma-client-%ec%84%a4%ec%a0%95">6-1. Prisma Client 설정</a></li>
<li><a href="#6-2-hash-%ea%b4%80%eb%a0%a8-bcryptjs-%ec%84%a4%ec%b9%98">6-2. hash 관련 bcryptjs 설치</a></li>
</ul>
</li>
<li><a href="#7-%ea%b0%80%ec%9e%85%ed%95%98%ea%b8%b0-%ed%99%94%eb%a9%b4-%eb%a7%8c%eb%93%a4%ea%b8%b0">7. 가입하기 화면 만들기</a></li>
<li><a href="#8-formdata%ec%9d%98-%ec%9c%a0%ed%9a%a8%ec%84%b1-%ea%b2%80%ec%82%ac">8. formData의 유효성 검사</a></li>
<li><a href="#9-%ec%9c%a0%ec%a0%80-%ec%a0%95%eb%b3%b4%eb%a5%bc-db%ec%97%90-%ec%a0%80%ec%9e%a5%ed%95%98%ea%b8%b0">9. 유저 정보를 DB에 저장하기</a></li>
<li><a href="#10-%eb%8f%99%ec%9d%bc-%ec%9d%b4%eb%a9%94%ec%9d%bc-%ec%97%90%eb%9f%ac-%ec%b2%98%eb%a6%ac%ed%95%98%ea%b8%b0">10. 동일 이메일 에러 처리하기</a></li>
<li><a href="#11-%ed%86%a0%ed%81%b0-%eb%a7%8c%eb%93%a4%ea%b8%b0">11. 토큰 만들기</a></li>
<li><a href="#12-%ec%bf%a0%ed%82%a4-%eb%a7%8c%eb%93%a4%ea%b8%b0">12. 쿠키 만들기</a></li>
<li><a href="#13-%eb%a1%9c%ea%b7%b8%ec%9d%b8-%ed%8e%98%ec%9d%b4%ec%a7%80-%eb%a7%8c%eb%93%a4%ea%b8%b0">13. 로그인 페이지 만들기</a></li>
<li><a href="#14-%eb%af%b8%eb%93%a4%ec%9b%a8%ec%96%b4%eb%a1%9c-%ed%8e%98%ec%9d%b4%ec%a7%80%eb%b3%84-%ec%95%a1%ec%84%b8%ec%8a%a4-%ec%a0%9c%ed%95%9c%ed%95%98%ea%b8%b0">14. 미들웨어로 페이지별 액세스 제한하기</a></li>
<li><a href="#15-%eb%a1%9c%ea%b7%b8%ec%95%84%ec%9b%83-%ea%b5%ac%ed%98%84">15. 로그아웃 구현</a></li>
<li><a href="#16-%eb%a1%9c%ea%b7%b8%ec%9d%b8-%ea%b0%80%ec%9e%85%ed%95%98%ea%b8%b0-%ed%8e%98%ec%9d%b4%ec%a7%80%ec%97%90-%eb%a6%ac%eb%8b%a4%ec%9d%b4%eb%a0%89%ed%8a%b8-%ec%bd%94%eb%93%9c-%ec%82%bd%ec%9e%85">16. 로그인, 가입하기 페이지에 리다이렉트 코드 삽입</a></li>
<li><a href="#17-%eb%b9%8c%eb%93%9c%eb%a5%bc-%ec%9c%84%ed%95%9c-%ec%96%b4%eb%8c%91%ed%84%b0-%ec%84%a4%ec%b9%98">17. 빌드를 위한 어댑터 설치</a></li>
</ul>
<hr>
<h2 id="1-astro-템플릿-설치">1. Astro 템플릿 설치</h2>
<p>일단 Astro를 설치하겠습니다.</p>
<p>옵션으로는 Typescript를 선택했습니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npm create astro@latest
</span></span><span class="line"><span class="cl">Need to install the following packages:
</span></span><span class="line"><span class="cl">  create-astro@4.6.0
</span></span><span class="line"><span class="cl">Ok to proceed? <span class="o">(</span>y<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> astro   Launch sequence initiated.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   dir   Where should we create your new project?
</span></span><span class="line"><span class="cl">         ./astro-prisma-auth-with-token
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  tmpl   How would you like to start your new project?
</span></span><span class="line"><span class="cl">         Empty
</span></span><span class="line"><span class="cl"> ██████  Template copying...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  deps   Install dependencies?
</span></span><span class="line"><span class="cl">         Yes
</span></span><span class="line"><span class="cl"> ██████  Installing dependencies with npm...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ts   Do you plan to write TypeScript?
</span></span><span class="line"><span class="cl">         Yes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   use   How strict should TypeScript be?
</span></span><span class="line"><span class="cl">         Strict
</span></span><span class="line"><span class="cl"> ██████  TypeScript customizing...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   git   Initialize a new git repository?
</span></span><span class="line"><span class="cl">         Yes
</span></span><span class="line"><span class="cl"> ██████  Git initializing...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  next   Liftoff confirmed. Explore your project!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         Enter your project directory using <span class="nb">cd</span> ./astro-prisma-auth-with-token
</span></span><span class="line"><span class="cl">         Run npm run dev to start the dev server. CTRL+C to stop.
</span></span><span class="line"><span class="cl">         Add frameworks like react or tailwind using astro add.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         Stuck? Join us at https://astro.build/chat
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">╭──🎁─╮  Houston:
</span></span><span class="line"><span class="cl">│ ◠ ◡ ◠  Good luck out there, astronaut! 🚀
</span></span><span class="line"><span class="cl">╰─────╯</span></span></code></pre></div>
  </figure>
</div>
<p>폴더로 들어가 &rsquo;npm run dev&rsquo;를 실행해 보면 브라우저에 Astro 문구가 잘 나올 겁니다.</p>
<hr>
<h2 id="2-쿠키-설정">2. 쿠키 설정</h2>
<p>쿠키 관련 Astro 문법은 예전 강좌 7편에 소개했던 적이 있습니다.</p>
<p><a href="https://mycodingshub.github.io/blog/2023-10-30-astrojs-howto-use-ssr-in-astrojs-server-side-rendering">astrojs 강좌 7편. astrojs Server Side Rendering(SSR) 완벽 분석</a></p>
<p>예전 문서를 보시면 서버 사이드 렌더링에 대해 잘 알 수 있는데요.</p>
<p>복습 차원에서 쿠키 작동 방법을 간단히 테스트해 보겠습니다.</p>
<p>먼저, src 폴더의 index.astro 파일을 아래와 같이 고친 다음 테스트해 보겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">cookie</span><span class="p">)</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">number</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">,</span> <span class="nb">String</span><span class="p">(</span><span class="nx">counter</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Counter</span> <span class="o">=</span> <span class="p">{</span><span class="nx">counter</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/html&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>개발 서버를 다시 돌려볼까요?</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">18:02:22 <span class="o">[</span>WARN<span class="o">]</span> <span class="sb">`</span>Astro.request.headers<span class="sb">`</span> is not available in <span class="s2">&#34;static&#34;</span> output mode. To <span class="nb">enable</span> header access: <span class="nb">set</span> <span class="sb">`</span>output: <span class="s2">&#34;server&#34;</span><span class="sb">`</span> or <span class="sb">`</span>output: <span class="s2">&#34;hybrid&#34;</span><span class="sb">`</span> in your config file.</span></span></code></pre></div>
  </figure>
</div>
<p>위와 같이 나옵니다.</p>
<p>왜냐하면 &lsquo;Astro.request.headers&rsquo;를 사용할 수 없다고 합니다.</p>
<p>Astro 옵션 구성에서 output 모드를 &lsquo;server&rsquo;나 &lsquo;hybrid&rsquo;로 바꾸라고 합니다.</p>
<p>왜냐하면 기본 모드는 정적 사이트(static)이기 때문에 서버 사이드 렌더링이 안 됩니다.</p>
<p>그래서 &lsquo;astro.config.mjs&rsquo; 파일에 다음과 같이 &lsquo;server&rsquo;라고 output 모드를 바꾸면 됩니다.</p>
<blockquote>
<p>Astro는 기본적으로 정적 모드로 작동하므로 빌드 시 페이지가 생성됩니다. astro.config.mjs에서 output의 값을 server 또는 hybrid로 하면 SSR(Server Side Rendering)로서 동작할 수 있어 액세스가 있을 때 페이지가 작성됩니다.</p></blockquote>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">defineConfig</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;astro/config&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// https://astro.build/config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="k">default</span> <span class="nx">defineConfig</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">output</span><span class="o">:</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span></span></span></code></pre></div>
  </figure>
</div>
<p>다시 개발 서버를 돌려볼까요?</p>
<p>처음에는 아래처럼 Counter 가 1로 나오다가 페이지를 새로고침 하면 새로고침한 만큼 숫자가 올라갑니다.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEilz5VBOew5rp74V_vav3-xXZlN6XF5apyPmNvB7kgHyB6rIv6_L-irpxLggo3xQ_-HjX4CXwMHkJo_9A8o5FvBTQV2tixeNkBHhfo2FEtqbQKYowbgS3jJmJxGCmXJVCWitlP_5J5sF9OmpZeYiNP4yIdieN1OX4UUKzz4sAhdOO5mMTHt6v-43kXGcZY"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgFfRasOic6jSjJLvkTPsAg2inN0r9YJXdlJ-jip_FpLRhQAj7D8bI3mcgKJ_pV-ZMjb_JHmso2eNyHciIIGL-5St-Tm90-w93KuCUtgAhbj57l0Up6l9DXgpL8ISV-U3RMtWfNq2DV1tXJHm-f5x8c3TDBvimMkvm6U9KvYGqS8W24zlimqc9bFlpKbII"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>크롬 개발창의 애플리케이션 쪽으로 가보면 쿠키라는 항목을 열어보면 아래 그림처럼 counter 쿠키가 존재합니다.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEil2KRs2SYz4eDLHpxR4wd73rgAWZ5eqC7CS_szKfUHHc1gsrL_uFM--JVllOeCdSa9_JIAw3Ez2PFCfTbeM0f_-8PJQ2jin6QA6OJCvvmEQ8remwNQxniVOw9BjKyOv0CEcMFGCg5lSLhDTxNpF_Klu7H6U4sIDam_EysyrosFFN_Ec0CjZq_i-CAIxkk"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>counter라는 쿠키의 속성을 보시면 중요한 게 몇 가지가 있는데요.</p>
<p>첫 번째, HttpOnly가 있습니다.</p>
<p>이 부분이 비어 있네요.</p>
<p>이 HttpOnly가 비어 있으면 쿠키를 클라이언트 사이드 쪽 자바스크립트로 접근이 가능합니다.</p>
<p>Astro를 서버 사이드 모드로 돌렸을 때 클라이언트 사이드 쪽 자바스크립트는 &lsquo;script&rsquo;를 쓰면 접근할 수 있는데요.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="nx">cookie</span><span class="p">)</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">number</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">,</span><span class="nb">String</span><span class="p">(</span><span class="nx">counter</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Counter</span> <span class="o">=</span> <span class="p">{</span><span class="nx">counter</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/html&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/script&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>위와 같이 설정하고 다시 크롬 개발창의 콘솔창 부분을 보시면 아래 그림처럼 counter 라는 쿠키값을 출력해 주고 있습니다.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEifh_txzsJfLuySugGe42Rg60evPBEIRugUycpWq0CBFU5ks16osoyqkcLOIUvXG0CSjfyBBLi5ZAFAqXrPgdlR5-qhTY7h7YUtGfts0c-1LE-qxLCnmNq2FpcYGiFhhkgPf4RiZ7g7bzSbm0svZwgsEfiWHipQo9z3_Ec_Wb3eujN7FcoBNKlQdftA39M"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>우리가 만들려고 하는 건 유저네임과 패스워드 방식의 Auth 서버이기 때문에 그리고 Auth 방식이 쿠키를 이용한 방식이기 때문에 클라이언트 사이드에서 쿠키에 접근하면 보안의 위험이 존재합니다.</p>
<p>그래서 쿠키 설정할 때 HttpOnly를 &rsquo;true&rsquo; 설정해서 오직 서버사이드에서만 접근할 수 있게 해야 합니다.</p>
<p>두 번째 중요한 쿠키 옵션은 secure 옵션입니다.</p>
<p>HTTP 통신의 경우에는 패킷 스니핑으로 토큰이 유출될 수 있어 오직 HTTPS 통신에만 쿠키가 전송되도록 secure 속성을 &rsquo;true&rsquo;로 설정할 수 있습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="nb">String</span><span class="p">(</span><span class="nx">counter</span><span class="p">),</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">secure</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span></span></span></code></pre></div>
  </figure>
</div>
<blockquote>
<p>Chrome에서는 개발 환경의 localhost의 경우 http 통신에서도 쿠키를 사용할 수 있습니다.</p></blockquote>
<p>세 번째 중요한 옵션은 &lsquo;Expires/Max-Age&rsquo;인데요.</p>
<p>쿠키의 만료일을 지정하는 겁니다.</p>
<p>기본 옵션은 &lsquo;Session&rsquo;이라고 하는 건데요.</p>
<p>이 옵션은 브라우저가 살아 있을 때까지입니다.</p>
<p>브라우저를 닫으면 종료됩니다.</p>
<p>이 방식도 괜찮은 방식인데요.</p>
<p>요즘은 로그인하는 게 귀찮아서 만료일을 7일 정도로 세팅하는게 추세입니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">maxAge</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="nb">String</span><span class="p">(</span><span class="nx">counter</span><span class="p">),</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">secure</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">maxAge</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span></span></span></code></pre></div>
  </figure>
</div>
<p>마지막에 maxAge라고만 적었는데 ES6의 축약 표기법으로 실제는 다음과 같은 겁니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">maxAge</span><span class="o">:</span> <span class="nx">maxAge</span></span></span></code></pre></div>
  </figure>
</div>
<p>최종 코드는 아래와 같습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="nx">cookie</span><span class="p">)</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">number</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">maxAge</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">,</span> <span class="nb">String</span><span class="p">(</span><span class="nx">counter</span><span class="p">),</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">secure</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">maxAge</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Counter</span> <span class="o">=</span> <span class="p">{</span><span class="nx">counter</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/html&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>아래 그림처럼 지정한 옵션 세 가지가 모두 적용되었네요.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEjkEoY3QYsBmqDKG10y3379QhOVz3NcHyDtqcq3VMTdt7lsINLBVoYbOCtgPJZyh_iuwXQMH2ZYhv4EFCGbTlxJwlyeqSVqg_Vpi4yZaNrqOM13OT_R22gmHk1wpIhjQAA-gU1M9utFxexkkCwZ9oyGmme6P1raeIPyrI0n_7AL35fVvotj_AMaWNpDbHI=w320-h36"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<hr>
<h2 id="3-middleware-설정">3. middleware 설정</h2>
<p>쿠키 검증 코드는 모든 HTTP 통신에 있어 사전에 체크해야 되기 때문에 미들웨어에서도 접근 가능해야 하는데요.</p>
<p>Astro에서는 middleware는 src 폴더 아래 middleware.ts 파일을 작성하면 됩니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">defineMiddleware</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;astro/middleware&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">onRequest</span> <span class="o">=</span> <span class="nx">defineMiddleware</span><span class="p">((</span><span class="nx">context</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span></span></span></code></pre></div>
  </figure>
</div>
<p>미들웨어를 설정했으면, 개발 서버를 다시 시작해야 합니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> astro  v4.0.8 ready in <span class="m">161</span> ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┃ Local    http://localhost:4321/
</span></span><span class="line"><span class="cl">┃ Network  use --host to expose
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">18:22:16 watching <span class="k">for</span> file changes...
</span></span><span class="line"><span class="cl">counter AstroCookie <span class="o">{</span> value: <span class="s1">&#39;6&#39;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">18:22:21 <span class="o">[</span>200<span class="o">]</span> / 81ms
</span></span><span class="line"><span class="cl">counter AstroCookie <span class="o">{</span> value: <span class="s1">&#39;7&#39;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">18:22:24 <span class="o">[</span>200<span class="o">]</span> / 8ms</span></span></code></pre></div>
  </figure>
</div>
<p>터미널 창에 counter라는 쿠키 관련 값이 제대로 표시가 됩니다.</p>
<hr>
<h2 id="4-prisma-설정">4. Prisma 설정</h2>
<p>사용자 정보를 저장하기 위해 DB를 이용해야 하는데요.</p>
<p>Typescript ORM으로 아주 유명한 Prisma를 이용하겠습니다.</p>
<hr>
<h3 id="4-1-prisma-설치">4-1. Prisma 설치</h3>
<p>먼저, 관련 Prisma 패키지를 설치하겠습니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npm install prisma -D</span></span></code></pre></div>
  </figure>
</div>
<p>Prisma 구성 파일을 세팅하려면 &lsquo;init&rsquo; 명령어를 주면 됩니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npx prisma init --datasource-provider sqlite
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">✔ Your Prisma schema was created at prisma/schema.prisma
</span></span><span class="line"><span class="cl">  You can now open it in your favorite editor.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">warn You already have a .gitignore file. Don<span class="err">&#39;</span>t forget to add <span class="sb">`</span>.env<span class="sb">`</span> in it to not commit any private information.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Next steps:
</span></span><span class="line"><span class="cl">1. Set the DATABASE_URL in the .env file to point to your existing database. If your database has no tables yet, <span class="nb">read</span> https://pris.ly/d/getting-started
</span></span><span class="line"><span class="cl">2. Run prisma db pull to turn your database schema into a Prisma schema.
</span></span><span class="line"><span class="cl">3. Run prisma generate to generate the Prisma Client. You can <span class="k">then</span> start querying your database.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">More information in our documentation:
</span></span><span class="line"><span class="cl">https://pris.ly/d/getting-started</span></span></code></pre></div>
  </figure>
</div>
<p>로컬 개발서버를 위해 sqlite를 선택했습니다.</p>
<p>자동으로 &lsquo;.env&rsquo; 파일도 만들어 줬네요.</p>
<p>그리고 스키마 파일인 &lsquo;schema.prisma&rsquo; 파일도 prisma 폴더 밑에 만들어 줬습니다.</p>
<p>이제 모델을 설정해야 하는데요.</p>
<hr>
<h2 id="4-2-model-설정">4-2. Model 설정</h2>
<p>Prisma는 모델이라는 걸로 데이터베이스 스키마를 구성합니다.</p>
<p>&lsquo;schema.prisma&rsquo; 파일에 Model을 추가합시다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// This is your Prisma schema file,
</span></span></span><span class="line"><span class="cl"><span class="c1">// learn more about it in the docs: https://pris.ly/d/prisma-schema
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">generator</span> <span class="nx">client</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">provider</span> <span class="o">=</span> <span class="s2">&#34;prisma-client-js&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">datasource</span> <span class="nx">db</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">provider</span> <span class="o">=</span> <span class="s2">&#34;sqlite&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">url</span>      <span class="o">=</span> <span class="nx">env</span><span class="p">(</span><span class="s2">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">model</span> <span class="nx">User</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">id</span>        <span class="nx">Int</span>      <span class="err">@</span><span class="nx">id</span> <span class="err">@</span><span class="k">default</span><span class="p">(</span><span class="nx">autoincrement</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="nx">email</span>     <span class="nb">String</span>   <span class="err">@</span><span class="nx">unique</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span>      <span class="nb">String</span><span class="o">?</span>
</span></span><span class="line"><span class="cl">  <span class="nx">password</span>  <span class="nb">String</span>
</span></span><span class="line"><span class="cl">  <span class="nx">createdAt</span> <span class="nx">DateTime</span> <span class="err">@</span><span class="k">default</span><span class="p">(</span><span class="nx">now</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="nx">updatedAt</span> <span class="nx">DateTime</span> <span class="err">@</span><span class="nx">updatedAt</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>User 모델인데요.</p>
<p>간단하게 email과 name, password만 구성했습니다.</p>
<p>로그인을 email과 password로만 이루어지게 할 예정입니다.</p>
<p>당연히, email은 unique 해야겠죠.</p>
<hr>
<h3 id="4-3-테이블-만들기">4-3. 테이블 만들기</h3>
<p>Prisma를 이용해서 모델을 만들었으면 실제 sqlite에 들어갈 테이블을 만들어야 합니다.</p>
<p>간단히 &lsquo;db push&rsquo; 명령어를 사용하면 됩니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npx prisma db push
</span></span><span class="line"><span class="cl">Environment variables loaded from .env
</span></span><span class="line"><span class="cl">Prisma schema loaded from prisma/schema.prisma
</span></span><span class="line"><span class="cl">Datasource <span class="s2">&#34;db&#34;</span>: SQLite database <span class="s2">&#34;dev.db&#34;</span> at <span class="s2">&#34;file:./dev.db&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SQLite database dev.db created at file:./dev.db
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">🚀  Your database is now in sync with your Prisma schema. Done in 15ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Running generate... <span class="o">(</span>Use --skip-generate to skip the generators<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">added <span class="m">1</span> package, and audited <span class="m">474</span> packages in 7s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">179</span> packages are looking <span class="k">for</span> funding
</span></span><span class="line"><span class="cl">  run <span class="sb">`</span>npm fund<span class="sb">`</span> <span class="k">for</span> details
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">found <span class="m">0</span> vulnerabilities
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">✔ Generated Prisma Client <span class="o">(</span>v5.7.1<span class="o">)</span> to ./node_modules/@prisma/client in 159ms</span></span></code></pre></div>
  </figure>
</div>
<p>&lsquo;dev.db&rsquo;라는 sqlite 파일에 테이블을 만들었고, Prisma Client도 만들어 줬네요.</p>
<hr>
<h3 id="4-4-prisma-studio에서-보기">4-4. Prisma Studio에서 보기</h3>
<p>Prisma는 Prisma Studio라는 웹 UI를 제공해 주는데요.</p>
<p>이게 아주 편합니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npx prisma studio</span></span></code></pre></div>
  </figure>
</div>
<p>실행하면 개발서버 5555번으로 브라우저가 열리면서 아래와 같이 보여주는데요.</p>
<p>우리가 만든 User 모델을 클릭해서 테이블 내용을 볼 수 있습니다.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEjWiykL8S1bxlODXdlO7TSZ6n-Jdb5z4C7WPgYCLmnRlTRH3WHFCrz8gvi0uFS03bGcP1SkHXyTjDvOmR8pqHy3DhkQJj4qB6C_A3boXEFwVjs-uU8mhn8QwMKx7lkhtypAs1mVQ9fKnU0aQIY_PXvWn9puybN5GOn4Wdl6njAaoNbAH16xwvbwdb_qBKI"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEhj4fdThECoqhIV8fJAqxlRegsBXX6PDEwLamuqsT-YqbTKRXVvOPDmV52ZKmiWqw66DI4iGSlA_fHbSf81bzcPuO4HYUrz9aT420hdLhv8IJfMylQrEHshju_j6DCcos7AA_2CVH6WLZWtd2rRrfExxPgJyJoBRjOkhxFtulJvq-DHmATKHxup-d2PP7I"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<hr>
<h2 id="5-ui-만들기">5. UI 만들기</h2>
<p>이제 로그인, 가입하기, 대시보드 등 Auth 관련 페이지를 만들어야 합니다.</p>
<p>대시보드 페이지는 로그인했을 때만 볼 수 있고,</p>
<p>&lsquo;/&rsquo; 루트 페이지는 로그인 여부와 관계없이 볼 수 있어야 하며,</p>
<p>로그인, 가입하기 페이지는 로그인되지 않았을 때만 볼 수 있어야겠죠.</p>
<hr>
<h3 id="5-1-레이아웃-파일-만들기">5-1. 레이아웃 파일 만들기</h3>
<p>Astro를 사용하면 레이아웃 파일을 만들어야 편합니다.</p>
<p>src 폴더에 layouts 폴더를 만들고 그 밑에 Layout.astro라는 파일을 만들겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// /src/layouts/Layout.astro
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ViewTransitions</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;astro:transitions&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">html</span> <span class="nx">lang</span><span class="o">=</span><span class="s2">&#34;en&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">charset</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;viewport&#34;</span> <span class="nx">content</span><span class="o">=</span><span class="s2">&#34;width=device-width, initial-scale=1&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">Astro</span><span class="o">&lt;</span><span class="err">/title&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">ViewTransitions</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/head&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">nav</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/&#34;</span><span class="o">&gt;</span><span class="nx">Home</span><span class="o">&lt;</span><span class="err">/a&gt;&lt;/li&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/dashboard&#34;</span><span class="o">&gt;</span><span class="nx">Dashboard</span><span class="o">&lt;</span><span class="err">/a&gt;&lt;/li&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/signup&#34;</span><span class="o">&gt;</span><span class="nx">Signup</span><span class="o">&lt;</span><span class="err">/a&gt;&lt;/li&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/login&#34;</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="err">/a&gt;&lt;/li&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="err">/ul&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/nav&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">slot</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/body&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/html&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ul</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">display</span><span class="o">:</span> <span class="nx">flex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gap</span><span class="o">:</span> <span class="mi">14</span><span class="nx">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">list</span><span class="o">-</span><span class="nx">style</span><span class="o">:</span> <span class="nx">none</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/style&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<h2 id="5-2-루트-페이지와-대시보드-페이지-만들기">5-2. 루트 페이지와 대시보드 페이지 만들기</h2>
<p>src 폴더의 index.astro는 아래와 같이 만들겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Home</span> <span class="nx">Page</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>그리고 src 폴더 밑에 있는 pages 폴더 밑에 dashboard 폴더를 만들고 그 밑에 index.astro 파일을 아래와 같이 만들겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Dashboard</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>이제까지의 설정이라면 아래 그림처럼 나올 겁니다.</p>
<p>링크가 아주 잘 작동하네요.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEiHtbObSY4Ds6gYJqAfNEnxTa4ko9eOOQiDWGo6Q8Wx4kWzWFWDehraDfd8EKEDjfYJiK0RupXLJR_VRWMjcD8QVxsVUloRGL26z9uRXyYVJ9tTCtwATdmWJ1rOhWL1rWxNaNB__kAcLfKtCD_wIB0PI1hDvwn7xGO7n4G02zeatzGge6iaJxExpR-PkNs"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<hr>
<h2 id="6-인증-관련-코드-설정">6. 인증 관련 코드 설정</h2>
<p>이제 전체적인 페이지의 구조가 갖춰졌으니 인증 관련 코드를 설정해 보겠습니다.</p>
<hr>
<h3 id="6-1-prisma-client-설정">6-1. Prisma Client 설정</h3>
<p>보통 src 폴더 밑에 prisma.ts 파일에 Prisma Client를 export 하는 코드를 작성합니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// /src/lib/prisma.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">PrismaClient</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;@prisma/client&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">prisma</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PrismaClient</span><span class="p">()</span></span></span></code></pre></div>
  </figure>
</div>
<hr>
<h3 id="6-2-hash-관련-bcryptjs-설치">6-2. hash 관련 bcryptjs 설치</h3>
<p>패스워드를 해시해서 저장해야 하므로 bcryptjs 패키지를 아래와 같이 설치하겠습니다.</p>
<p>그리고 토큰 형식으로 쿠키에 저장해야 하므로 가장 유명한 jsonwebtoken 패키지도 같이 설치하겠습니다.</p>
<p>그리고 zod를 이용해서 타입 유효성을 검사해야 하므로 zod도 같이 설치하겠습니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npm install bcryptjs jsonwebtoken zod
</span></span><span class="line"><span class="cl">npm install @types/bcryptjs @types/jsonwebtoken -D</span></span></code></pre></div>
  </figure>
</div>
<hr>
<h2 id="7-가입하기-화면-만들기">7. 가입하기 화면 만들기</h2>
<p>유저를 생성하는 가입하기 화면을 만들어야 하는데요.</p>
<p>이 파일은 바로 라우팅이 되기 때문에 src 폴더 밑에 있는 pages 폴더에 &lsquo;signup.astro&rsquo;라는 파일을 만들겠습니다.</p>
<p>아래 링크의 Astro 공식 문서에 가면 signup 폼을 아주 잘 설명해 준 게 있습니다.</p>
<p><a href="https://docs.astro.build/en/recipes/build-forms/">Build HTML forms in Astro pages</a></p>
<p>위 링크를 한번 읽어 보시는 걸 추천드립니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// /src/pages/signup.astro
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="nx">up</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&#34;post&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;name&#34;</span><span class="o">&gt;</span><span class="nx">Name</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;name&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;name&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;email&#34;</span><span class="o">&gt;</span><span class="nx">Email</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">required</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;password&#34;</span><span class="o">&gt;</span><span class="nx">Password</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;password&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;password&#34;</span> <span class="nx">required</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">button</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="nx">Up</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/login&#34;</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEi7UsbgW-DlRo-b7dc_1FGlUP2deriVEn_Zu-cnHlQqLaElIbZo7TwvVNIVXHjMLyCIR8mVlUHZI-KPGOv1aQxVH_n3q5fgmaGF7npthrf32-LblklU0Wt9OWe3G7KoPsKSLfhmts68s1jaK55w99yHKkw0jGcRcwYKuoP3YxFDAKyhdxpu_UH7XUt4B_A"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>위와 같이 깔끔한 Sign up 페이지가 작성되었네요.</p>
<p>그러면 이제 테스트를 위해 더미 데이터를 넣고 Signup 버튼을 눌러보겠습니다.</p>
<p>여기서 가장 기본이 되는 HTTP의 form 행동 양식에 대해 설명해 드리자면, 위 코드에서 &lsquo;form&rsquo; 태그를 잘 보십시오.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="o">&gt;</span><span class="p">...</span><span class="o">&lt;</span><span class="err">/form&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>method가 &lsquo;post&rsquo;라고만 되어 있네요.</p>
<p>HTTP POST 리퀘스트는 보통 데이터를 클라이언트에서 서버로 전달하기 위해 쓰입니다.</p>
<p>그리고 이렇게 POST 메서드를 처리하는 서버의 주소 즉, API 엔드포인트는 action이라는 항목으로 지정하는데요.</p>
<p>위에서 보듯이 &lsquo;form&rsquo; 태그에는 action 항목이 없습니다.</p>
<p>action 항목이 없으면 현재 페이지로 POST 리퀘스트를 보낸다는 겁니다.</p>
<p>즉, 다음과 같은 거죠.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s1">&#39;post&#39;</span> <span class="nx">action</span><span class="o">=</span><span class="s1">&#39;/signup&#39;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/form&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>signup 라우팅이 현재 페이지인데요.</p>
<p>우리가 Sign Up 버튼을 누르면 form이 submit 되면서 리퀘스트가 POST 메서드 방식으로 &ldquo;/signup&rdquo; 라우팅으로 갑니다.</p>
<p>우리가 만든 Astro는 서버 사이드 렌더링이기 때문에 같은 페이지에서 서버 사이드 코드를 처리할 수 있습니다.</p>
<p>따로 API 엔드포인트를 안 만들어도 되는 거죠.</p>
<p>그러면 &lsquo;/src/pages/signup.astro&rsquo; 파일의 첫 부분에 POST 메서드의 HTTP 리퀘스트를 처리할 수 있는 코드를 추가해 보겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&#34;POST&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">formData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;password&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 밑에 html 코드는 이전과 동일
</span></span></span></code></pre></div>
  </figure>
</div>
<p>Astro에서 리퀘스트는 &lsquo;Astro.request&rsquo; 객체를 통해 손쉽게 접근가능합니다.</p>
<p>위와 같이 if 문을 두어 &ldquo;POST&rdquo; 리퀘스트일 때만 작동하는 코드를 넣었습니다.</p>
<p>그리고 HTML의 FormData를 통해 우리가 입력한 name, email, password를 얻을 수 있습니다.</p>
<p>이 방식이 가장 기본적은 HTTP의 기본 작동 방식이죠.</p>
<p>적당한 이름을 넣고 &lsquo;Sign Up&rsquo; 버튼을 누르면 터미널 창에 아래와 같이 나올 겁니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">18:57:02 <span class="o">[</span>200<span class="o">]</span> /signup 19ms
</span></span><span class="line"><span class="cl">counter AstroCookie <span class="o">{</span> value: <span class="s1">&#39;8&#39;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> test@test.com <span class="m">1234</span></span></span></code></pre></div>
  </figure>
</div>
<p>왜 터미널창에 나오냐면 서버 사이드 코드이기 때문입니다.</p>
<p>제가 입력한 데로 잘 나오고 있네요.</p>
<hr>
<h2 id="8-formdata의-유효성-검사">8. formData의 유효성 검사</h2>
<p>우리가 지금 Typescript를 쓰고 있기 때문에 formData의 유효성을 검사하는 게 중요합니다.</p>
<p>zod의 safeParse 함수를 사용할 때가 온 거죠.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">z</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">object</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">email</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">password</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">safeParse</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">password</span> <span class="p">})</span></span></span></code></pre></div>
  </figure>
</div>
<p>위와 같이 한 번에 써도 되고, 아래와 같이 나눠서 써도 됩니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">email</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">password</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">password</span> <span class="p">})</span></span></span></code></pre></div>
  </figure>
</div>
<p>이제 signup.astro 파일을 다시 써보면,</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">z</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;zod&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&#34;POST&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">formData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;password&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">z</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">object</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">email</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">password</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">safeParse</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">password</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;result&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 밑에 html 코드는 이전과 동일
</span></span></span></code></pre></div>
  </figure>
</div>
<p>위와 같이 작성했고, 다시 테스트를 위해 &lsquo;Sign Up&rsquo; 버튼을 눌러볼까요?</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">result <span class="o">{</span>
</span></span><span class="line"><span class="cl">  success: true,
</span></span><span class="line"><span class="cl">  data: <span class="o">{</span> email: <span class="s1">&#39;test2@test2.com&#39;</span>, name: <span class="s1">&#39;test2&#39;</span>, password: <span class="s1">&#39;00000000&#39;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>위와 같이 zod 가 리턴해주는 result 값이 아주 잘 나오고 있습니다.</p>
<p>success 가 true, false 값이면 유효성 검증을 success 항목만 참고하면 되겠네요.</p>
<p>그리고 result.data 항목에 입력한 formData가 잘 나오고 있습니다.</p>
<p>일부러 실패해 볼까요?</p>
<p>email은 불완전하게 넣고 password는 8글자 보다 적게 넣어보겠습니다.</p>
<p>그러면 아래와 같이 나오는데요.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">result</span> <span class="p">{</span> <span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="p">[</span><span class="nx">Getter</span><span class="p">]</span> <span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>success가 false일 경우 error를 표시해 주는 console.log를 추가하겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">issues</span><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>
</span></span><span class="line"><span class="cl">  <span class="o">{</span>
</span></span><span class="line"><span class="cl">    validation: <span class="s1">&#39;email&#39;</span>,
</span></span><span class="line"><span class="cl">    code: <span class="s1">&#39;invalid_string&#39;</span>,
</span></span><span class="line"><span class="cl">    message: <span class="s1">&#39;Invalid email&#39;</span>,
</span></span><span class="line"><span class="cl">    path: <span class="o">[</span> <span class="s1">&#39;email&#39;</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="o">{</span>
</span></span><span class="line"><span class="cl">    code: <span class="s1">&#39;too_small&#39;</span>,
</span></span><span class="line"><span class="cl">    minimum: 8,
</span></span><span class="line"><span class="cl">    type: <span class="s1">&#39;string&#39;</span>,
</span></span><span class="line"><span class="cl">    inclusive: true,
</span></span><span class="line"><span class="cl">    exact: false,
</span></span><span class="line"><span class="cl">    message: <span class="s1">&#39;String must contain at least 8 character(s)&#39;</span>,
</span></span><span class="line"><span class="cl">    path: <span class="o">[</span> <span class="s1">&#39;password&#39;</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">]</span></span></span></code></pre></div>
  </figure>
</div>
<p>위와 같이 zod가 아주 잘 작동하고 있습니다.</p>
<p>result.error.issues 항목을 잘 다룬다면 가입하기 페이지에서 실제 사용자에게 뭐가 잘못되었는지 상세하기 알려줄 수가 있겠네요.</p>
<p>이제 가입하기 페이지에서 유효성 검사에 실패하면 issues 변수에 저장하여 브라우저에 표시되도록 설정해 보겠습니다.</p>
<p>또 유효성 검사에 실패하면 Astro.response.status에서 상태 코드 400(Bad Request)을 반환하도록 설정하겠습니다.</p>
<p>Astro.response.status를 설정하지 않으면 기본적으로 상태 코드 200이 반환되기 때문에 꼭 Astro.response.status를 설정하는 게 좋습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">z</span> <span class="nx">from</span> <span class="s2">&#34;zod&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">issues</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">ZodIssue</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&#34;POST&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">formData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;password&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">z</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">object</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">email</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">password</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">safeParse</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">password</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">issues</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">errors</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="nx">up</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&#34;post&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;name&#34;</span><span class="o">&gt;</span><span class="nx">Name</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;name&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;name&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;email&#34;</span><span class="o">&gt;</span><span class="nx">Email</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">required</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;password&#34;</span><span class="o">&gt;</span><span class="nx">Password</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;password&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;password&#34;</span> <span class="nx">required</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">issues</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">issues</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">issue</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="nx">issue</span><span class="p">.</span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span><span class="o">:</span><span class="p">{</span><span class="nx">issue</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">button</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="nx">Up</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/login&#34;</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>가입하기 페이지의 UI 부분이 완성되었습니다.</p>
<p>일부러 틀리게 테스트해 보면 아래와 같이 브라우저에 그 내용이 나타나게 됩니다.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEjZ1cFwtdGo6-LAigIAsh-pmXbDfvGtX8RnKf-NzYxg5I_wEHS0IAZB75ft0a3W3DDLDvRkvwe45IFdvWiA0ogx1GCdIfSQ3qgW5iziSzSzub84ibsuniQbw56LoNrJCU6lPr1qUSqkNh7PSrnS0O1aOcbQ3pT8Tj4xIH_vaFhRTT4D_iA6T3_xY4I1t7w"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>일단 여기까지 성공입니다.</p>
<p>그런데, form의 submit 특성상 submit 버튼을 누르면 입력한 값이 없어집니다.</p>
<p>에러가 날 경우 사용자가 입력한 값이 남아 있어야 뭐가 틀렸는지 알 수 있는데요.</p>
<p>이 부분을 수정해 보겠습니다.</p>
<p>Astro에서는 아래와 같이 간단하게 처리할 수 있습니다.</p>
<p>각 항목의 변수 값을 따로 만들고 input 태그의 value값에 넣어주면 됩니다.</p>
<p>이건 React가 아니라서 onChange를 신경 쓰지 않아도 되죠.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">z</span> <span class="nx">from</span> <span class="s2">&#34;zod&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">issues</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">ZodIssue</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">nameInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">emailInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">passwordInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&#34;POST&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">formData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;password&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">nameInput</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">emailInput</span> <span class="o">=</span> <span class="nx">email</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">passwordInput</span> <span class="o">=</span> <span class="nx">password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">z</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">object</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">email</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">password</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">safeParse</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">password</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">issues</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">errors</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="nx">up</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&#34;post&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;name&#34;</span><span class="o">&gt;</span><span class="nx">Name</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;name&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;name&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">nameInput</span><span class="p">}</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;email&#34;</span><span class="o">&gt;</span><span class="nx">Email</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">emailInput</span><span class="p">}</span> <span class="nx">required</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;password&#34;</span><span class="o">&gt;</span><span class="nx">Password</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">passwordInput</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">required</span>
</span></span><span class="line"><span class="cl">      <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">issues</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">issues</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">issue</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="nx">issue</span><span class="p">.</span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span><span class="o">:</span><span class="p">{</span><span class="nx">issue</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">button</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="nx">Up</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/login&#34;</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>다시 테스트를 해볼까요?</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEhKAerZgLkDWJfDxGogmev5r1idSwOa8J4sOVTSFgmTD7R1_hurk_HQjNXXr0NURtGL7CneOshEmrfKCfMwv5G1YhZMOYk00vve15zC9c0FdDh1WW2D8slbDgdOymeaJ9MAIYHwMAbDoFuxtDIz8d1UT4zIC_gWauEIPUEl8B9eEEY2Y-bnLcf55UGZltE"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>위와 같이 밑에 에러 표시가 되면서 동시에 사용자가 입력한 값이 유지되고 있습니다.</p>
<hr>
<h2 id="9-유저-정보를-db에-저장하기">9. 유저 정보를 DB에 저장하기</h2>
<p>이제 정상적으로 입력했을 경우 DB에 저장하는 부분을 작성해야겠네요.</p>
<p>아까 만들었던 &rsquo;lib/prisma.ts&rsquo; 파일에서 Prisma Client를 불러와서 create 해주면 됩니다.</p>
<p>코드가 위치할 곳은 아래와 같이 실패했을 때 보여주던 error 표시 다음인데요.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">z</span> <span class="nx">from</span> <span class="s2">&#34;zod&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;../lib/prisma&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 기존 동일
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">issues</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">errors</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">email</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">password</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>위와 같이 유효성 검증이 실패하지 않았을 경우 prisma.user.create 함수를 통해 DB에 작성하게 됩니다.</p>
<p>테스트를 위해 유효성 검증을 통과할 수 있게 유저 정보를 넣어 보겠습니다.</p>
<p>화면 표시는 그대로 입력한 값이 나오고 있고 터미널 창에는 아래와 같이 POST 메서드가 작동했다고 나오네요.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">counter AstroCookie <span class="o">{</span> value: <span class="s1">&#39;8&#39;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">19:20:12 <span class="o">[</span>200<span class="o">]</span> POST /signup 15ms</span></span></code></pre></div>
  </figure>
</div>
<p>그 와중에 middleware에 설정했던 console.log도 잘 나오고 있습니다.</p>
<p>이제 Prisma Studio로 가서 데이터가 잘 들어왔는지 볼까요?</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEh2Ou1jHCT5licLLE2NevzIixSzS28T_R278qROep7v-BhMBWj7RYjEyuSdFVdbaBtmhlqy4PoOAT00R0-XuHD9F0RLbmNLsBDnchsREVI8fUsM49DjvbK9dELZmWzZlm-2sVmIUf1egmIKf-oZmpHdFq7h4wgnVcxEEFHqZjfjPAqs-9XY5uyurhistTI"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>위와 같이 데이터가 잘 들어왔네요.</p>
<p>그런데 패스워드가 일반 텍스트입니다.</p>
<p>절대 이렇게 설계하면 안 됩니다.</p>
<p>패스워드는 해시된 상태로 저장해야 하죠.</p>
<p>아까 설치한 bcryptjs 라이브러리를 사용할 때가 왔네요.</p>
<p>아까 if-else 부분에 아래와 같이 고치면 됩니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">z</span> <span class="nx">from</span> <span class="s2">&#34;zod&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;../lib/prisma&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">bcrypt</span> <span class="nx">from</span> <span class="s2">&#34;bcryptjs&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 기존과 동일
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">issues</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">errors</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">salt</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">hashedPassword</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hashSync</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">email</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">password</span><span class="o">:</span> <span class="nx">hashedPassword</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>이제 다시 테스트해볼까요?</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEjVoxoMlZtZTsMrZLGRleN0paSciUZRkH2QAei6Fo4sFmLiIIE85q_ISM2VcqHCOU3tBCxndaSakU5n0O2rzHbKzUmm0V5OgDo4oeDeeMa2oB9XGocmLO66EwXl-mWk2cdhXk00Gu-tGlbtTiaH9QTYr3_-YV05azUYPBjSIArXfsC--x6hWLXNckAy3xY"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>위와 같이 test2 라는 이름의 패스워드는 해시된 상태로 잘 저장되었네요.</p>
<hr>
<h2 id="10-동일-이메일-에러-처리하기">10. 동일 이메일 에러 처리하기</h2>
<p>이메일은 유니크하게 설정했었는데요.</p>
<p>왜냐하면 이메일은 사람마다 고유하기 때문입니다.</p>
<p>그래서 가입할 때 이메일이 중복되었다는 거는 유저가 이전에 가입한 정보가 있다는 겁니다.</p>
<p>테스트를 위해 아까 가입한 &rsquo;test2@test.com&rsquo; 이라는 이메일을 다시 사용해서 가입해 보겠습니다.</p>
<p>터미널 창은 아래와 같은 에러가 나오고, 브라우저도 같은 에러가 나옵니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">19:27:18 <span class="o">[</span>ERROR<span class="o">]</span>
</span></span><span class="line"><span class="cl">Invalid <span class="sb">`</span>prisma.user.create<span class="o">()</span><span class="sb">`</span> invocation:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Unique constraint failed on the fields: <span class="o">(</span><span class="sb">`</span>email<span class="sb">`</span><span class="o">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgnLTH_pAh26zVAwlDNnesye9LOd0xXRWhjjMGwrV4ElRJp0wlbx6yN1nJGCKn-nc3TAjvLerWpNQ6psxtUA04M5IYji0JcT9s2UaN7VLSndAs3ftzWiFki0CUZn0Ds3mvKxFoZ7tVdJWR8iaHf-5EyKHnWwpNbI6zU_YavpTXlPr0cXDm1lVNcpttDetI"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>Prisma가 친절하게 에러 이유도 가르쳐 주고 있네요.</p>
<p>코드에 이 부분을 점검하는 부분을 추가해 보겠습니다.</p>
<p>유저에세 에러 메시지를 잘 보여주기 위해 errors라는 배열을 따로 만들어서 처리해 보도록 하겠습니다.</p>
<p>prisma.user.create 부분에서 try, catch 문을 이용해서 Prisma가 내뿜는 PrismaClientKnownRequestError 관련 에러를 캐치해서 처리해 보도록 하겠습니다.</p>
<p>전체 코드입니다.</p>
<p>HTML 쪽 에러 사유를 보여주는 곳도 수정했습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">z</span> <span class="nx">from</span> <span class="s2">&#34;zod&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;../lib/prisma&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">bcrypt</span> <span class="nx">from</span> <span class="s2">&#34;bcryptjs&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;@prisma/client&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">ErrorMessage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="nx">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">message</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">errors</span><span class="o">:</span> <span class="nx">ErrorMessage</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">nameInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">emailInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">passwordInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&#34;POST&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">formData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;password&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">nameInput</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">emailInput</span> <span class="o">=</span> <span class="nx">email</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">passwordInput</span> <span class="o">=</span> <span class="nx">password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">z</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">object</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">email</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">password</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">safeParse</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">password</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">errors</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">message</span><span class="o">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">salt</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hashedPassword</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hashSync</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">name</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">email</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">password</span><span class="o">:</span> <span class="nx">hashedPassword</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">Prisma</span><span class="p">.</span><span class="nx">PrismaClientKnownRequestError</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s2">&#34;P2002&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">errors</span> <span class="o">=</span> <span class="p">[{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;email already registered&#34;</span> <span class="p">}];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="nx">up</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&#34;post&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;name&#34;</span><span class="o">&gt;</span><span class="nx">Name</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;name&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;name&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">nameInput</span><span class="p">}</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;email&#34;</span><span class="o">&gt;</span><span class="nx">Email</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">emailInput</span><span class="p">}</span> <span class="nx">required</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;password&#34;</span><span class="o">&gt;</span><span class="nx">Password</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">passwordInput</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">required</span>
</span></span><span class="line"><span class="cl">      <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">errors</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">:</span><span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">button</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="nx">Up</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/login&#34;</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>다시 일부러 에러를 내 볼까요?</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEg1eb3JZD0A94lgt1DPaZQH5btuAMb9Tt3yA7ZhZrzOTgzjd2AtzGnuC2aiMMYK2kMRCxLTo4_XDpX9HrfFloD1_za0pq__K95T5GHeOdx7-LeYUSxGA54gYPdIHiOvBOCmt63YkMvGnoDBjhNkaw4DAsPLHuZ5eFJ8FekJuUl0A7CYqDwsDhVdCD8xeBE"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>위 그림과 같이 email 중복 에러도 잘 잡아내고 있습니다.</p>
<hr>
<h2 id="11-토큰-만들기">11. 토큰 만들기</h2>
<p>사용자가 가입하기를 통해 성공적으로 가입을 했으면 그 상태로 로그인한 상태가 돼야 합니다.</p>
<p>우리가 이번 강좌에서 사용할 로그인 방식은 토큰을 이용한 방식이죠.</p>
<p>그래서 토큰을 생성해 보도록 하겠습니다.</p>
<p>jsonwebtoken 패키지를 사용할 겁니다.</p>
<p>토큰의 secret는 보통 &lsquo;.env&rsquo; 파일에 작성하면 됩니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## .env</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">DATABASE_URL</span><span class="o">=</span><span class="s2">&#34;file:./dev.db&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">SECRET</span><span class="o">=</span>asdfasdfsadfasdfsadf</span></span></code></pre></div>
  </figure>
</div>
<p>아무 글자나 넣으면 됩니다.</p>
<p>토큰(token)을 만들려면 jwt.sign 함수를 아래와 같이 사용하면 됩니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">email</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="nx">expiresIn</span><span class="o">:</span> <span class="s1">&#39;1d&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>Astro는 Vite를 이용하고 있어서 &lsquo;import.meta.env.SECRET&rsquo;라는 방식으로 사용하면 됩니다.</p>
<p>타입스크립트를 위해서 &rsquo;env.d.ts&rsquo;파일에 SECRET 관련 타입도 아래와 같이 지정하겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">/// &lt;reference types=&#34;astro/client&#34; /&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">ImportMetaEnv</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">readonly</span> <span class="nx">SECRET</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">interface</span> <span class="nx">ImportMeta</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">readonly</span> <span class="nx">env</span><span class="o">:</span> <span class="nx">ImportMetaEnv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>token을 만드는 코드는 어디에 위치해야 할까요?</p>
<p>당연히 Prisma를 이용해서 DB에 사용자 정보를 create 완료했을 때입니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">jwt</span> <span class="nx">from</span> <span class="s2">&#34;jsonwebtoken&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">salt</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">hashedPassword</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hashSync</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">email</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">password</span><span class="o">:</span> <span class="nx">hashedPassword</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">email</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="nx">expiresIn</span><span class="o">:</span> <span class="s2">&#34;1d&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>코드가 너무 길어 위와 같이 코드 일부분만 보여줬습니다.</p>
<p>들어갈 위치만 확인하시고 넣어주시면 됩니다.</p>
<p>그리고 prisma.user.create의 결과 값을 user 변수에 저장했습니다.</p>
<p>그래서 jwt.sign 함수에 user.id, user.name, user.email 값을 이용할 수 있게 되는 거죠.</p>
<p>여기서 신기한게 지금까지 만든 모든 코드는 아래 if 문 안에 있는 겁니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&#34;POST&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>즉, 유저가 form 데이터를 입력하고 submit 버튼을 눌러 POST 메서드가 실행되었을 때 작동하는 코드인 거죠.</p>
<p>웹 서버의 가장 기본이 되는 작동 방식입니다.</p>
<p>테스트를 위해서 새로운 가입자를 입력하고 터미널 창을 볼까요?</p>
<p>토큰이 어떻게 나오는지 확인해 보도록 하겠습니다.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">counter AstroCookie <span class="o">{</span> value: <span class="s1">&#39;8&#39;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MywibmFtZSI6InRlc3Q1IiwiZW1haWwiOiJ0ZXN0NUB0ZXN0LmNvbSIsImlhdCI6MTcwNDE5MjA3NiwiZXhwIjoxNzA0Mjc4NDc2fQ.-iVFexjKGcNoaOUGJ9ZLAIGw9r1qe5Z3WCGqch5VmL8</span></span></code></pre></div>
  </figure>
</div>
<p>토큰 값이 나왔네요.</p>
<p>이걸 디코드할 수 있는 <a href="https://jwt.io">https://jwt.io</a> 페이지에서 살펴보겠습니다.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEjb9VZW6NnnON4zx920Qu0VJuw4RBRd5JR6zJDcJ2IzgRx8HhIN882Za10ITAhpP6Ly6wivsj6hCTEkGU_VhoG1okqkBCNkdVbWsWYXUZXDNhJzax7Pb9xSg2zn43CZ4imFNhCvyeIPX00ScVKL6v4pWZBq1w2opCPZk_swpd_NYW-qnobsFrKZLEAU75U"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>위와 같이 나오는데요.</p>
<p>알고리즘은 &lsquo;HS256&rsquo;이고, 방식은 &lsquo;JWT&rsquo;라고 나옵니다.</p>
<p>그리고 입력했던 name, email 정보도 정확하네요.</p>
<p>이렇게 토큰을 디코드하면 사용자 정보를 확인할 수 있습니다.</p>
<p>그래서 우리가 사용자가 로그인되었다는 정보를 쿠키에 토큰을 저장하고, 필요할 때 디코드하면 되는 거죠.</p>
<hr>
<h2 id="12-쿠키-만들기">12. 쿠키 만들기</h2>
<p>토큰 작성이 완료되었네요.</p>
<p>이 토큰을 쿠키에 저장하는 코드를 만들면 됩니다.</p>
<p>토큰은 &rsquo;token&rsquo;이라는 변수에 저장했었죠.</p>
<p>쿠키는 아래와 같이 만들면 됩니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;mytoken&#39;</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">secure</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">maxAge</span><span class="o">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/dashboard&#39;</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>쿠키 이름은 &lsquo;mytoken&rsquo;이네요.</p>
<p>이 이름을 특별하게 만드는 게 중요합니다.</p>
<p>보통 사이트 이름과 연관하여 만드는게 중요하죠.</p>
<p>다른 웹사이트랑 쿠키 이름이 중복되면 안 되니까요?</p>
<p>그리고 쿠키를 저장했으면 모든 가입하기 로직이 끝났기 때문에 대시보드로 이동하는 &lsquo;redirect&rsquo; 명령어를 실행시키면 됩니다.</p>
<p>이코드는 jwt.sign 함수 아래쪽에 넣으시면 됩니다.</p>
<p>혹시나 해서 signup.astro 파일의 전체 코드를 보여드리겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">z</span> <span class="nx">from</span> <span class="s2">&#34;zod&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;../lib/prisma&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">bcrypt</span> <span class="nx">from</span> <span class="s2">&#34;bcryptjs&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;@prisma/client&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">jwt</span> <span class="nx">from</span> <span class="s2">&#34;jsonwebtoken&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">ErrorMessage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="nx">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">message</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">errors</span><span class="o">:</span> <span class="nx">ErrorMessage</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">nameInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">emailInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">passwordInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&#34;POST&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">formData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;name&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;password&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">nameInput</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">emailInput</span> <span class="o">=</span> <span class="nx">email</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">passwordInput</span> <span class="o">=</span> <span class="nx">password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">z</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">object</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">email</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">password</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">safeParse</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">password</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">errors</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">message</span><span class="o">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">salt</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hashedPassword</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hashSync</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">name</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">email</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">password</span><span class="o">:</span> <span class="nx">hashedPassword</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">id</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">name</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">email</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="nx">expiresIn</span><span class="o">:</span> <span class="s2">&#34;1d&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;mytoken&#34;</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">secure</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">maxAge</span><span class="o">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">&#34;/dashboard&#34;</span><span class="p">,</span> <span class="mi">302</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">Prisma</span><span class="p">.</span><span class="nx">PrismaClientKnownRequestError</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s2">&#34;P2002&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">errors</span> <span class="o">=</span> <span class="p">[{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;email already registered&#34;</span> <span class="p">}];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="nx">up</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&#34;post&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;name&#34;</span><span class="o">&gt;</span><span class="nx">Name</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;name&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;name&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">nameInput</span><span class="p">}</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;email&#34;</span><span class="o">&gt;</span><span class="nx">Email</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">emailInput</span><span class="p">}</span> <span class="nx">required</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;password&#34;</span><span class="o">&gt;</span><span class="nx">Password</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">passwordInput</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">required</span>
</span></span><span class="line"><span class="cl">      <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">errors</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">:</span><span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">button</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="nx">Up</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/login&#34;</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>테스트를 위해 새로운 사용자를 가입해 볼까요?</p>
<p>정상적으로 입력하면 대시보드로 페이지가 이동되고, 크롬 개발창의 애플리케이션 쪽으로 가서 쿠키를 보시면 아래와 같이 mytoken이라는 쿠키가 보이고, 맨 처음 만들었던 counter 쿠키도 보이네요.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgvg192GVQFtIwIPPiwMSvh8TA1omgEd7Gart3Np0nW9pnhwo0G4RdTOToc-bF5w7_j5HsAiieKdlDu0JP4jPjiFhyr8b-7tnW_Wc3jzcdyw5dnGcSTBa7gUlYtNpL56YpqzgeQ7o1AlsYieGB0Ed4ZbgkeYjq7iIKY0fnZFITahqnf4EG5-e4zB925HrY"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>counter 쿠키는 삭제하지 않아서 계속 보이네요.</p>
<p>mytoken 쿠키의 값에 우리가 만든 토큰 값이 있습니다.</p>
<hr>
<h2 id="13-로그인-페이지-만들기">13. 로그인 페이지 만들기</h2>
<p>유저 가입하기 페이지를 만들었으니 로그인 페이지를 만들어야겠죠.</p>
<p>로그인 로직은 간단합니다.</p>
<p>이메일과 패스워드만 폼데이터로 받아서 그걸 DB의 이메일과 패스워드와 비교해서 맞으면 해당 토큰을 만들고, 다시 그 토큰을 mytoken이라는 쿠키에 저장하면 되는 거죠.</p>
<p>src 폴더 밑의 pages 폴더 밑에 login.astro 라는 파일을 아래와 같이 만듭니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">z</span> <span class="nx">from</span> <span class="s2">&#34;zod&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;../lib/prisma&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">bcrypt</span> <span class="nx">from</span> <span class="s2">&#34;bcryptjs&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">jwt</span> <span class="nx">from</span> <span class="s2">&#34;jsonwebtoken&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">ErrorMessage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="nx">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">message</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">errors</span><span class="o">:</span> <span class="nx">ErrorMessage</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">emailInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">passwordInput</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&#34;POST&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">formData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;email&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;password&#34;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">emailInput</span> <span class="o">=</span> <span class="nx">email</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">passwordInput</span> <span class="o">=</span> <span class="nx">password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">z</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">object</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">email</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">password</span><span class="o">:</span> <span class="nx">z</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">safeParse</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">errors</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">message</span><span class="o">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">where</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">email</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">errors</span> <span class="o">=</span> <span class="p">[{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Invalid credentials&#34;</span> <span class="p">}];</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">valid</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compareSync</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">valid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">errors</span> <span class="o">=</span> <span class="p">[{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;password&#34;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Invalid credentials&#34;</span> <span class="p">}];</span>
</span></span><span class="line"><span class="cl">          <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nx">id</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nx">name</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nx">email</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span> <span class="nx">expiresIn</span><span class="o">:</span> <span class="s2">&#34;1d&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="nx">Astro</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;mytoken&#34;</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">secure</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxAge</span><span class="o">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">&#34;/dashboard&#34;</span><span class="p">,</span> <span class="mi">302</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">Astro</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&#34;post&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;email&#34;</span><span class="o">&gt;</span><span class="nx">Email</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;email&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">emailInput</span><span class="p">}</span> <span class="nx">required</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">&#34;password&#34;</span><span class="o">&gt;</span><span class="nx">Password</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="nx">input</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">passwordInput</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">required</span>
</span></span><span class="line"><span class="cl">      <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">errors</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">:</span><span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">button</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/signup&#34;</span><span class="o">&gt;</span><span class="nx">SigUp</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>전체 코드입니다.</p>
<p>왜냐하면 가입하기 로직과 거의 비슷하기 때문입니다.</p>
<p>먼저, 아래 코드처럼 이메일이 있는지 확인합니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">where</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">email</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span></span></span></code></pre></div>
  </figure>
</div>
<p>그리고 해당 이메일이 있으면 그 사용자 정보를 user 변수에 저장하고 나서 다시 해시된 패스워드와 비교합니다.</p>
<p>해시된 패스워드를 비교하는 함수는 bcrypt.compareSync 함수를 사용하면 됩니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">valid</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compareSync</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span></span></span></code></pre></div>
  </figure>
</div>
<p>이 함수는 동기식인데요.</p>
<p>이 함수가 비동기식이면 문제가 되죠.</p>
<p>패스워드 확인도 못했는데 다음 코드를 수행하면 안 되니까요.</p>
<p>그러면 아까 가입했던 유저 정보로 로그인해볼까요?</p>
<p>수작업으로 mytoken이라는 쿠키를 삭제하고 시도해야 합니다.</p>
<p>아직 logout 로직이 없어서 이죠.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEj3GGUv-pSvzBYJ9TJHSLvucdkZSBseHyjQYXKl71g6bu4rKWHDEnHBgAKmVtbiUYJeDk-Syk-WuLTKBcBphwYEtYjROvTtRQ09OaEeo-77KWjZRYTXdG5XooKDx39rFW_JaYij6R-LjXaioTghKSQFY1BGW1B76EnDyvGAq1G4aUBkfOlXbMg5mDNF5OQ"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>위 그림처럼 mytoken 쿠키값이 없을 때 로그인을 시도하면 아래와 같이 mytoken이 생깁니다.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEigikaPZWVHxQNO0W0padDVtUMjywtyDUwdX4_mUzu67z79-_oWlu0Os8v8rICH0TKAhTKdSePbpNDkxDTQTZTMhfpricMB4yf2Xs_02SJf5Umw7fYTlGJw2mlyNyZBPuI9jjy8G1QnTxYOy0OiCQBFs7qrvFG4NZiFFMQFMh7-iaA2_bdzQmtCztIc9O0"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>로그인 로직도 완성되었습니다.</p>
<hr>
<h2 id="14-미들웨어로-페이지별-액세스-제한하기">14. 미들웨어로 페이지별 액세스 제한하기</h2>
<p>로그인 상태에 따라 각 페이지별 액세스를 제한하는 방식을 취해야 하는데요.</p>
<p>로그인된 상태에서 가입하기 페이지와 로그인 페이지에 또 들어가면 좋은 UX가 아니지 않습니까?</p>
<p>미들웨어를 이용해서 하면 쉬운데요.</p>
<p>아래 코드를 보시면 &lsquo;allowedPaths&rsquo; 변수에 허용할 라우팅 주소를 넣습니다.</p>
<p>allowedPath는 로그인 상관없는 페이지라서 바로 next() 함수를 호출하면 됩니다.</p>
<p>이제 allowedPath에 포함되지 않은 페이지에 액세스하는 경우 쿠키에 포함된 토큰을 검색하고 토큰이 존재하는 경우 유효성 검사를 수행합니다.</p>
<p>검증 후의 데이터는 context.locals에 user 라는 이름으로 저장하고 있습니다.</p>
<p>Astro에서 글로벌 전역 변수 같은 거죠.</p>
<p>context.locals를 이용하면 어떤 Astro 페이지에서도 쉽게 접근할 수 있어 아주 편합니다.</p>
<p>그래서 context.locals.user 라는 값에 토큰을 디코드해서 얻은 사용자 정보를 입력해서 로그인 유무를 나타내는 거죠.</p>
<p>쿠키가 없으면 user에는 null이 포함됩니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">defineMiddleware</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;astro/middleware&#39;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">jwt</span> <span class="nx">from</span> <span class="s1">&#39;jsonwebtoken&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">allowedPaths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">onRequest</span> <span class="o">=</span> <span class="nx">defineMiddleware</span><span class="p">((</span><span class="nx">context</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">allowedPaths</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">))</span> <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">context</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;mytoken&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">decoded</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="nx">context</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">decoded</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span></span></span></code></pre></div>
  </figure>
</div>
<p>위와 같이 미들웨어를 작성하면 됩니다.</p>
<p>타입스크립트가 user 부분에 에러가 있다고 나오는데요.</p>
<p>user 타입을 지정해야 합니다.</p>
<p>&rsquo;env.d.ts&rsquo; 파일에 아래와 같이 추가하면 됩니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">/// &lt;reference types=&#34;astro/client&#34; /&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">interface</span> <span class="nx">ImportMetaEnv</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">readonly</span> <span class="nx">SECRET</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">ImportMeta</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">readonly</span> <span class="nx">env</span><span class="o">:</span> <span class="nx">ImportMetaEnv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">declare</span> <span class="nx">namespace</span> <span class="nx">App</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">interface</span> <span class="nx">Locals</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">user</span><span class="o">:</span> <span class="kc">null</span> <span class="o">|</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">id</span><span class="o">:</span> <span class="nx">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">?:</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">email</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>이제 미들웨어에서 로그인된 상태의 유저 정보가 context.locals.user 변수에 저장되기 때문에 이 정보를 이용해서 UI를 바꿔주면 됩니다.</p>
<p>일단 로그인된 상태에서 보여주는 라우팅 주소인 대시보드를 수정해 보겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// src/pages/dashboard/index.astro
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">&#34;/login&#34;</span><span class="p">,</span> <span class="mi">302</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Dashboard</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>로그인된 유저 정보를 아주 쉽게 Astro.locals.user 값에서 얻어 올 수 있습니다.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgnc7NaxR9H9NIPGjw-o0ig_Y3y4NY5f3NidKNy8x09qd4ZEH_DkpxjvpiB1DDoH7bBRyXqnEwHl0FONRRarzM5bUX4ZCOWbB_vHA6e3ZRKd581-H4mKxNS-QidhSjSr5v3rtg6W-Yzx69FpOHJGG8110C2LYVlTtJOyriReZ8DAvb-1tUWeHQtN3SHwQo"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>위와 같이 정상적으로 작동하네요.</p>
<p>만약 로그인되지 않은 상태에서는 &lsquo;/login&rsquo; 라우팅으로 리다이렉트가 됩니다.</p>
<hr>
<h2 id="15-로그아웃-구현">15. 로그아웃 구현</h2>
<p>로그아웃을 구현해야 하는데요.</p>
<p>로그아웃은 &lsquo;mytoken&rsquo;이라는 쿠키값을 삭제하면 됩니다</p>
<p>pages 폴더 밑에 logout.ts 파일을 만들겠습니다.</p>
<p>이 파일은 API 엔드 포인트라서 확장자가 ts로 끝납니다.</p>
<p>주소로써 &lsquo;/logout&rsquo;에만 HTTP 리퀘스트를 하면 로그아웃이 되는 거죠.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">type</span> <span class="p">{</span> <span class="nx">APIRoute</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;astro&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">POST</span><span class="o">:</span> <span class="nx">APIRoute</span> <span class="o">=</span> <span class="kr">async</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">context</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;mytoken&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>쿠키를 삭제하고 &lsquo;/login&rsquo;으로 리다이렉트 시킵니다.</p>
<p>그러면 로그아웃 버튼을 어떻게 만들까요?</p>
<p>간단하게 form으로 &lsquo;/logout&rsquo; 이라는 action 값을 넣어서 HTTP POST 리퀘스트를 하면 됩니다.</p>
<p>대시보드 페이지에 로그아웃 버튼을 추가해 보겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">&#34;/login&#34;</span><span class="p">,</span> <span class="mi">302</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Dashboard</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Name</span><span class="o">:</span> <span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Email</span><span class="o">:</span> <span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&#34;post&#34;</span> <span class="nx">action</span><span class="o">=</span><span class="s2">&#34;/logout&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;submit&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;Logout&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>맨 처음 form을 설명드렸을 때 얘기했던 action 항목이 보입니다.</p>
<p>action 항목에 주소를 넣으면 그 주소로 리퀘스트가 일어난다는 뜻입니다.</p>
<p>테스트 해보시면 잘 작동하는 걸 볼 수 있을 겁니다.</p>
<hr>
<h2 id="16-로그인-가입하기-페이지에-리다이렉트-코드-삽입">16. 로그인, 가입하기 페이지에 리다이렉트 코드 삽입</h2>
<p>만약 로그인된 상태일 경우 로그인, 가입하기 페이지에 있을 필요가 없죠.</p>
<p>그래서 코드 맨 처음에 아래와 같은 코드를 넣으면 됩니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// login.astro , signup.astro
</span></span></span><span class="line"><span class="cl"><span class="c1">// 마지막 줄에 넣으면 됩니다.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 즉 아래 if 문 다음입니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Astro</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&#34;POST&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">&#34;/dashboard&#34;</span><span class="p">,</span> <span class="mi">302</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span></span></span></code></pre></div>
  </figure>
</div>
<p>이제 로그인한 상태에서 &lsquo;/signup&rsquo;, &lsquo;/login&rsquo; 주소로 가면 무조건 대시보드로 이동하게 됩니다.</p>
<p>그러면 Home 라우팅 주소인 &lsquo;/&lsquo;에서는 유저 정보가 안 나타나죠.</p>
<p>왜냐하면 미들웨어에서 allowedPaths 배열에 &lsquo;/&lsquo;를 넣었기 때문에 user 정보를 디코드하지 않기 때문입니다.</p>
<p>미들웨어를 아래와 같이 바꾸면 Home 주소에서도 유저 정보에 접근할 수 있습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">defineMiddleware</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;astro/middleware&#39;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">jwt</span> <span class="nx">from</span> <span class="s1">&#39;jsonwebtoken&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// const allowedPaths = [&#34;/&#34;];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">onRequest</span> <span class="o">=</span> <span class="nx">defineMiddleware</span><span class="p">((</span><span class="nx">context</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// if (allowedPaths.includes(context.url.pathname)) return next();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nx">context</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;mytoken&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">decoded</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="nx">context</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">decoded</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span></span></span></code></pre></div>
  </figure>
</div>
<p>위와 같이 주석 처리하고 Home 페이지는 pages 폴더 밑의 index.astro 파일을 아래와 같이 고치겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Layout</span> <span class="nx">from</span> <span class="s2">&#34;../layouts/Layout.astro&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Astro</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">Layout</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Home</span> <span class="nx">Page</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">user</span> <span class="o">?</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nx">You</span> <span class="nx">are</span> <span class="s2">&#34;{user.name} / {user.email}&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="err">/h2&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&#34;post&#34;</span> <span class="nx">action</span><span class="o">=</span><span class="s2">&#34;/logout&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;submit&#34;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&#34;Logout&#34;</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="err">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">:</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">You</span> <span class="nx">are</span> <span class="nx">not</span> <span class="nx">logged</span> <span class="k">in</span><span class="p">.</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;/login&#34;</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;</span><span class="err">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/Layout&gt;</span></span></span></code></pre></div>
  </figure>
</div>
<p>실행결과는 아래와 같습니다.</p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEh9L3uMS1k9D8GJsJL2X6KjvRN6_OLO1vZMED3STiSD6pqC95sLB68Q1agT4F_aCXWlflyx_Mtade7KzqZvUhagUNm__zUxEHgM9p5XZ7kTjk6S2KGm-nkpcS97y_GDrOHSrSUul9PpIfHW_5zFeYLIk6UFtZri5JQIQ9p6Txcx_V-y_lFnDadOleuGYrc"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<p>
  <figure>
    <img src="https://blogger.googleusercontent.com/img/a/AVvXsEihlZ5nof1-QWVG3rD9uMCEajaLnjCu9dngmCNLhymcrM59zOMfc8lhZdOQSDt3dMHbJ9pyX9brrbYpYkT31829MdHSC7cPjdAg2kGqii9uP9pWRswM5XEdr-rifFapvoCB7y9-DUWyw48flj7nlOYRt2r-9vM-EgPpAxuruhSw8uScieI8G23y2TlmqME"
         alt=""
         
         class="img-fluid"
         loading="lazy"
         decoding="async" />
    
  </figure></p>
<hr>
<h2 id="17-빌드를-위한-어댑터-설치">17. 빌드를 위한 어댑터 설치</h2>
<p>astro.config.mjs 파일에서 output이 &lsquo;server&rsquo;이기 때문에 빌드하려면 어댑터가 필요합니다.</p>
<p>배포하기 위한 각 클라우드별 어댑터가 있으니 공식 홈페이지를 참고 바라며, 가장 기본적인 Node 어댑터를 설치해 보겠습니다.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">npx</span> <span class="nx">astro</span> <span class="nx">add</span> <span class="nx">node</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">npm</span> <span class="nx">run</span> <span class="nx">build</span></span></span></code></pre></div>
  </figure>
</div>
<p>이제 빌드가 정상적으로 됐네요.</p>
<p>dist 폴더에 가볼까요?</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">tree --du -h ./dist
</span></span><span class="line"><span class="cl"><span class="o">[</span>201K<span class="o">]</span>  ./dist
</span></span><span class="line"><span class="cl">├── <span class="o">[</span> 13K<span class="o">]</span>  client
</span></span><span class="line"><span class="cl">│   ├── <span class="o">[</span> 12K<span class="o">]</span>  _astro
</span></span><span class="line"><span class="cl">│   │   └── <span class="o">[</span> 12K<span class="o">]</span>  hoisted.4PK_pqbL.js
</span></span><span class="line"><span class="cl">│   └── <span class="o">[</span> 749<span class="o">]</span>  favicon.svg
</span></span><span class="line"><span class="cl">└── <span class="o">[</span>188K<span class="o">]</span>  server
</span></span><span class="line"><span class="cl">    ├── <span class="o">[</span> 664<span class="o">]</span>  _astro-internal_middleware.mjs
</span></span><span class="line"><span class="cl">    ├── <span class="o">[</span>107K<span class="o">]</span>  chunks
</span></span><span class="line"><span class="cl">    │   ├── <span class="o">[</span> 11K<span class="o">]</span>  astro
</span></span><span class="line"><span class="cl">    │   │   └── <span class="o">[</span> 11K<span class="o">]</span>  assets-service_viW8rF43.mjs
</span></span><span class="line"><span class="cl">    │   ├── <span class="o">[</span> 73K<span class="o">]</span>  astro_CiCEMB--.mjs
</span></span><span class="line"><span class="cl">    │   ├── <span class="o">[</span> 890<span class="o">]</span>  index_3CUD5-aQ.mjs
</span></span><span class="line"><span class="cl">    │   ├── <span class="o">[</span> 200<span class="o">]</span>  index_5EsQHg9G.mjs
</span></span><span class="line"><span class="cl">    │   ├── <span class="o">[</span> 200<span class="o">]</span>  index_gzawo1fc.mjs
</span></span><span class="line"><span class="cl">    │   ├── <span class="o">[</span> 200<span class="o">]</span>  login_kDQSl8PX.mjs
</span></span><span class="line"><span class="cl">    │   ├── <span class="o">[</span> 186<span class="o">]</span>  logout__QUDrWfQ.mjs
</span></span><span class="line"><span class="cl">    │   ├── <span class="o">[</span> 184<span class="o">]</span>  node_0famb6YR.mjs
</span></span><span class="line"><span class="cl">    │   ├── <span class="o">[</span> 21K<span class="o">]</span>  pages
</span></span><span class="line"><span class="cl">    │   │   ├── <span class="o">[</span>4.3K<span class="o">]</span>  index_Ahlbjwl9.mjs
</span></span><span class="line"><span class="cl">    │   │   ├── <span class="o">[</span>3.5K<span class="o">]</span>  login_K2j71GLI.mjs
</span></span><span class="line"><span class="cl">    │   │   ├── <span class="o">[</span> 134<span class="o">]</span>  logout_qAe24DUv.mjs
</span></span><span class="line"><span class="cl">    │   │   ├── <span class="o">[</span>9.6K<span class="o">]</span>  node_uJ98dHhL.mjs
</span></span><span class="line"><span class="cl">    │   │   └── <span class="o">[</span>3.6K<span class="o">]</span>  signup_PbE-VfQX.mjs
</span></span><span class="line"><span class="cl">    │   └── <span class="o">[</span> 186<span class="o">]</span>  signup_mGJsesMi.mjs
</span></span><span class="line"><span class="cl">    ├── <span class="o">[</span> 69K<span class="o">]</span>  entry.mjs
</span></span><span class="line"><span class="cl">    ├── <span class="o">[</span> 11K<span class="o">]</span>  manifest_rqdvmMgq.mjs
</span></span><span class="line"><span class="cl">    ├── <span class="o">[</span> 257<span class="o">]</span>  middleware.mjs
</span></span><span class="line"><span class="cl">    └── <span class="o">[</span>  45<span class="o">]</span>  renderers.mjs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 552K used in <span class="m">7</span> directories, <span class="m">21</span> files</span></span></code></pre></div>
  </figure>
</div>
<p>총 522K 사이즈네요.</p>
<p>정말 작습니다.</p>
<p>dist 폴더의 server 폴더에 들어가시면 entry.mjs 파일이 있죠.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <pre tabindex="0"><code>node dist/server/entry.mjs
20:31:37 [@astrojs/node] Server listening on http://127.0.0.1:4321</code></pre>
  </figure>
</div>
<p>이렇게 정식 프로덕션 빌드판을 웹 서버에서 실행하시면 서버가 실행되는 겁니다.</p>
<p>당연히 우분투 서버에 우리가 작성한 코드 전부를 복사해서 그대로 build해야 합니다.</p>
<p>왜냐하면 필요한 파일이 &rsquo;node_modules&rsquo; 폴더가 필요하고,</p>
<p>그 다음으로 prisma 폴더, &lsquo;.env&rsquo; 파일도 필요하기 때문입니다.</p>
<p>그럼.</p>

      <div class="tag-list-single">
        <a class="btn btn-light" href="/tags/astrojs/" role="button">astrojs</a>
        <a class="btn btn-light" href="/tags/auth/" role="button">auth</a>
        <a class="btn btn-light" href="/tags/cookie/" role="button">cookie</a>
        <a class="btn btn-light" href="/tags/jwt/" role="button">jwt</a>
        <a class="btn btn-light" href="/tags/token/" role="button">token</a>
        <a class="btn btn-light" href="/tags/jsonwebtoken/" role="button">jsonwebtoken</a>
        </div>
      
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-format="autorelaxed"
          data-ad-client="ca-pub-7748316956330968"
          data-ad-slot="4495825428"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>
</article>

      
      </div>
    </div>
    
    
<div class="bg-light">
    <section class="section section-related container">
      <div class="row justify-content-center">
        <div class="col-md-12 col-lg-12">
          <h2 class="section-title text-center">Related posts</h2>
        </div>
      </div>
      <div class="row justify-content-center">
        <div class="col-lg-12">
          <div class="card">
              <div class="card-body">
                <article>
                  <h2 class="h3"><a class="stretched-link text-body" href="/blog/2024-01-16-astrojs-tutorial-auth-with-lucia/">astrojs 강좌 11편. astrojs와 lucia를 이용해서 유저 인증 구현</a></h2>
                  <p>Lucia auth를 이용해서 Astrojs에서 유저 가입하기, 로그인, 로그아웃 구현하기</p>
                  <p>
  <small>January 16, 2024<span class="stretched-link position-relative reading-time text-nowrap" title="Estimated reading time"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
        <path d="M12 7v5l3 3"></path>
      </svg>12&nbsp;minutes</span></small>
</p>
</article>
              </div>
            </div>
          <div class="card">
              <div class="card-body">
                <article>
                  <h2 class="h3"><a class="stretched-link text-body" href="/blog/2023-11-09-astrojs-howto-supabase-authentication-with-ssr/">astrojs 강좌 9편. astrojs와 supabase로 유저 로그인 구현</a></h2>
                  <p>Supabase의 Authentication을 이용해서 AstroJS에서 유저 로그인 구현하기</p>
                  <p>
  <small>November 9, 2023<span class="stretched-link position-relative reading-time text-nowrap" title="Estimated reading time"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
        <path d="M12 7v5l3 3"></path>
      </svg>11&nbsp;minutes</span></small>
</p>
</article>
              </div>
            </div>
          <div class="card">
              <div class="card-body">
                <article>
                  <h2 class="h3"><a class="stretched-link text-body" href="/blog/2023-06-03-nextauth-nextjs-tutorial-protected-route-and-jwt-token/">NextAuth 사용법 4편 - 토큰을 이용한 세션 보호</a></h2>
                  <p>NextAuth 사용법 4편 - 토큰을 이용한 세션 보호</p>
                  <p>
  <small>June 3, 2023<span class="stretched-link position-relative reading-time text-nowrap" title="Estimated reading time"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
        <path d="M12 7v5l3 3"></path>
      </svg>7&nbsp;minutes</span></small>
</p>
</article>
              </div>
            </div>
          </div>
      </div>
    </section>
    <script src="https://utteranc.es/client.js"
      repo="cpro95/utterances_mycodings_fly_dev"
      issue-term="pathname"
      theme="github-light"
      label="blog-comment"
      crossorigin="anonymous"
    async>
    </script>
  </div>
  
    <footer class="footer text-muted">
  <div class="container-lg">
    <div class="row">
      <div class="col-lg-8 text-center text-lg-start">
        <ul class="list-inline">
          <li class="list-inline-item"><a class="text-muted" href="/about/">about</a></li>
        </ul>
      </div>
      <div class="col-lg-8 text-center text-lg-end">
        <ul class="list-inline">
          <li class="list-inline-item">Copyright (c) All Right Reserved.</li>
        </ul>
      </div>
    </div>
  </div>
</footer>

    

<script async
  src="/js/app.19b73e0182301dd61c9211c2f6890104740e2eb9eb12fe4ba8d4f31435b22ed6.js"
  integrity="sha256-Gbc&#43;AYIwHdYckhHC9okBBHQOLrnrEv5LqNTzFDWyLtY=">
</script>





<script async
  src="/js/flexsearch.5dd6433c29c3e043627f046054aed58ff3790f58fdb8423f45125bbafdcad335.js"
  integrity="sha256-XdZDPCnD4ENifwRgVK7Vj/N5D1j9uEI/RRJbuv3K0zU=">
</script>
<script async
  src="/js/search-modal.96e662d8f691fe25c859a3437074b485f2d7bed0bca612725028c6cf4322e2f2.js"
  integrity="sha256-luZi2PaR/iXIWaNDcHS0hfLXvtC8phJyUCjGz0Mi4vI=">
</script>

    <div class="d-inline-flex fixed-bottom-right pb-4 pe-4">
  <button id="toTop" type="button" class="btn btn-primary rounded-circle ms-auto p-2"><span class="visually-hidden">Top</span><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-up" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M6 15l6 -6l6 6"></path></svg></button>
</div>

    
  </body>
</html>
